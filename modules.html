<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Barbadillo's Modular Art System</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f0f0f0;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .controls {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Grid 15% larger than previous 266px */
    .grid-container {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 2px;
      background: #333;
      padding: 2px;
      border-radius: 4px;
      width: min(306px, 90vw);
      margin-inline: auto;
    }

    .cell {
      aspect-ratio: 1;
      background: white;
      position: relative;
    }

    .module {
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
      transition: transform 0.3s ease;
    }

    button {
      padding: 8px 16px;
      margin: 5px;
      border: none;
      border-radius: 4px;
      background: #2196f3;
      color: white;
      cursor: pointer;
    }

    button:hover { background: #1976d2; }

    .module-selector { margin: 10px 0; }
  </style>
</head>
<body>
  <div class="container">
    <div class="controls">
      <h2>Module Controls</h2>
      <div class="module-selector">
        <button onclick="selectModule('a')">Module A</button>
        <button onclick="selectModule('b')">Module B</button>
        <button onclick="selectModule('c')">Module C</button>
        <button onclick="selectModule('d')">Module D</button>
      </div>
      <button onclick="rotateSelected()">Rotate Selected</button>
      <button onclick="flipSelected()">Flip Selected</button>
      <button onclick="invertColors()">Invert Colors</button>
      <button onclick="clearGrid()">Clear Grid</button>
      <button onclick="downloadGridAsPNG()">Download as PNG</button>
    
    </div>

    <div class="grid-container" id="grid"></div>
  </div>

  <script>
    const modules = {
      a: `<svg viewBox="0 0 100 100"><path d="M0,0 L100,0 L100,100 L0,100 Z" fill="white"/><path d="M0,0 Q50,0 50,50 Q50,100 0,100 Z" fill="black"/></svg>`,
      b: `<svg viewBox="0 0 100 100"><path d="M0,0 L100,0 L100,100 L0,100 Z" fill="white"/><path d="M0,0 Q100,0 100,50 Q100,100 0,100 Z" fill="black"/></svg>`,
      c: `<svg viewBox="0 0 100 100"><path d="M0,0 L100,0 L100,100 L0,100 Z" fill="white"/><path d="M0,0 Q50,0 50,50 Q50,100 100,100 L0,100 Z" fill="black"/></svg>`,
      d: `<svg viewBox="0 0 100 100"><path d="M0,0 L100,0 L100,100 L0,100 Z" fill="white"/><path d="M50,0 Q100,0 100,50 Q100,100 50,100 Q0,100 0,50 Q0,0 50,0 Z" fill="black"/></svg>`
    };

    let selectedCell = null;
    let currentModule = 'a';

    function createGrid() {
      const grid = document.getElementById('grid');
      for (let i = 0; i < 16; i++) {
        const cell = document.createElement('div');
        cell.className = 'cell';
        cell.onclick = () => selectCell(cell);
        grid.appendChild(cell);
      }
    }

    function selectCell(cell) {
      if (selectedCell) selectedCell.style.outline = 'none';
      selectedCell = cell;
      cell.style.outline = '2px solid #2196f3';
      if (!cell.querySelector('.module')) {
        const module = document.createElement('div');
        module.className = 'module';
        module.innerHTML = modules[currentModule];
        cell.appendChild(module);
      }
    }

    function selectModule(type) {
      currentModule = type;
      if (selectedCell && selectedCell.querySelector('.module')) {
        selectedCell.querySelector('.module').innerHTML = modules[type];
      }
    }

    function rotateSelected() {
      if (selectedCell) {
        const module = selectedCell.querySelector('.module');
        if (module) {
          const current = module.style.transform || '';
          const match = current.match(/rotate\((\d+)deg\)/);
          const angle = match ? parseInt(match[1]) : 0;
          module.style.transform = current.replace(/rotate\(\d+deg\)/, '').trim() + ` rotate(${(angle + 90) % 360}deg)`;
        }
      }
    }

    function flipSelected() {
      if (selectedCell) {
        const module = selectedCell.querySelector('.module');
        if (module) {
          if (module.style.transform.includes('scaleX(-1)')) {
            module.style.transform = module.style.transform.replace('scaleX(-1)', '').trim();
          } else {
            module.style.transform += ' scaleX(-1)';
          }
        }
      }
    }

    function invertColors() {
      if (selectedCell) {
        const svg = selectedCell.querySelector('svg');
        if (svg) {
          svg.querySelectorAll('path').forEach(path => {
            const fill = path.getAttribute('fill');
            path.setAttribute('fill', fill === 'black' ? 'white' : 'black');
          });
        }
      }
    }

    function clearGrid() {
      document.querySelectorAll('.cell').forEach(cell => {
        cell.innerHTML = '';
        cell.style.outline = 'none';
      });
      selectedCell = null;
    }

    async function downloadGridAsPNG() {
      const cells = Array.from(document.querySelectorAll('.cell'));
      const size = 306; // 15% larger than 266px
      const cellSize = size / 4;
      const canvas = document.createElement('canvas');
      canvas.width = size;
      canvas.height = size;
      const ctx = canvas.getContext('2d');

      function loadSvgAsImage(svgText) {
        return new Promise(resolve => {
          const img = new Image();
          const svgBlob = new Blob([svgText], { type: 'image/svg+xml;charset=utf-8' });
          const url = URL.createObjectURL(svgBlob);
          img.onload = () => resolve({ img, url });
          img.src = url;
        });
      }

      for (let i = 0; i < cells.length; i++) {
        const cell = cells[i];
        const moduleDiv = cell.querySelector('.module');
        if (!moduleDiv) continue;

        const svgText = moduleDiv.innerHTML.trim();
        const transform = moduleDiv.style.transform || '';
        const col = i % 4;
        const row = Math.floor(i / 4);

        const { img, url } = await loadSvgAsImage(svgText);

        ctx.save();
        ctx.translate(col * cellSize + cellSize / 2, row * cellSize + cellSize / 2);

        const angleMatch = transform.match(/rotate\((\d+)deg\)/);
        const angle = angleMatch ? parseInt(angleMatch[1]) * Math.PI / 180 : 0;
        const flipped = transform.includes('scaleX(-1)') ? -1 : 1;

        ctx.rotate(angle);
        ctx.scale(flipped, 1);
        ctx.drawImage(img, -cellSize / 2, -cellSize / 2, cellSize, cellSize);
        ctx.restore();

        URL.revokeObjectURL(url);
      }

      const link = document.createElement('a');
      link.download = 'modular-art.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    }

    function openMuseumText() {
      const url = 'modulestext.html';
      const w = Math.min(700, window.screen.width - 100);
      const h = Math.min(500, window.screen.height - 100);
      const left = Math.max(0, Math.round((window.screen.width - w) / 2));
      const top = Math.max(0, Math.round((window.screen.height - h) / 2));
      const features = `popup=yes,scrollbars=yes,resizable=yes,width=${w},height=${h},left=${left},top=${top}`;
      const win = window.open(url, 'BarbadilloTextPanel', features);
      if (!win) window.open(url, '_blank');
      else win.focus();
    }

    createGrid();
  </script>
</body>
</html>
