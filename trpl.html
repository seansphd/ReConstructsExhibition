<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>TRPL - Line Pattern Generator</title>
<style>
    * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
    }
    body {
        font-family: system-ui, -apple-system, sans-serif;
        margin: 0;
        padding: 10px;
        background: #f5f5f5;
        text-align: center;
        overflow-x: hidden;
    }
    .container {
        max-width: 1200px;
        margin: 0 auto;
    }
    h1 {
        font-size: clamp(1.2rem, 5vw, 2rem);
        margin: 10px 0;
    }
    .controls {
        background: white;
        padding: 15px 10px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 15px;
    }
    .control-row {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 15px;
        margin-bottom: 10px;
    }
    .control-group {
        text-align: center;
        min-width: 100px;
    }
    label {
        display: block;
        font-weight: 500;
        margin-bottom: 5px;
        font-size: 0.9rem;
    }
    input[type="number"] {
        width: 80px;
        padding: 8px 4px;
        text-align: center;
        font-size: 16px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    .action-row {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
        margin-top: 15px;
    }
    button {
        background: #2563eb;
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        touch-action: manipulation;
        white-space: nowrap;
    }
    button:hover {
        background: #1d4ed8;
    }
    button:active {
        transform: scale(0.98);
    }
    #canvas-container {
        position: relative;
        margin-top: 15px;
        display: flex;
        justify-content: center;
        touch-action: none;
    }
    #drawingCanvas {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        cursor: crosshair;
        max-width: 100%;
        height: auto;
        touch-action: none;
    }
    #status {
        margin-top: 10px;
        color: #666;
        font-size: 0.9rem;
        padding: 0 10px;
    }
    @media (max-width: 600px) {
        body {
            padding: 5px;
        }
        .controls {
            padding: 10px 5px;
        }
        .control-row {
            gap: 10px;
        }
        .control-group {
            min-width: 85px;
        }
        label {
            font-size: 0.85rem;
        }
        button {
            padding: 8px 12px;
            font-size: 13px;
        }
        input[type="number"] {
            width: 70px;
        }
    }
</style>
</head>
<body>
<div class="container">
    <h1>TRPL - Line Pattern Generator</h1>
    <div class="controls">
        <div class="control-row">
            <div class="control-group">
                <label for="height">Height (YMOD):</label>
                <input type="number" id="height" value="400" min="100" max="800">
            </div>
            <div class="control-group">
                <label for="width">Width (WIDE):</label>
                <input type="number" id="width" value="600" min="100" max="1200">
            </div>
            <div class="control-group">
                <label for="interpolations">Interpolations (XMOD):</label>
                <input type="number" id="interpolations" value="20" min="2" max="100">
            </div>
            <div class="control-group">
                <label for="resolution">Resolution:</label>
                <input type="number" id="resolution" value="100" min="50" max="200">
            </div>
        </div>
        <div class="action-row">
            <button id="clearBtn">Clear</button>
            <button id="generateBtn">Generate</button>
            <button id="undoBtn">Undo</button>
            <button id="downloadBtn">Download</button>
            <button id="museumBtn">Museum Text</button>
        </div>
    </div>
    <div id="status">Draw at least two master lines by clicking and dragging on the canvas.</div>
    <div id="canvas-container">
        <canvas id="drawingCanvas" width="600" height="400"></canvas>
    </div>
</div>

<script>
class TRPL {
    constructor(canvas) {
        this.canvas = canvas;
        this.ctx = canvas.getContext('2d');
        this.masterLines = [];
        this.isDrawing = false;
        this.resolution = 100;
        this.currentLine = null;
        this.setupEventListeners();
        this.updateStatus();
        this.resizeCanvas();
    }
    
    setupEventListeners() {
        // Mouse events
        this.canvas.addEventListener('mousedown', (e) => this.startDrawing(e));
        this.canvas.addEventListener('mousemove', (e) => this.draw(e));
        this.canvas.addEventListener('mouseup', () => this.stopDrawing());
        this.canvas.addEventListener('mouseout', () => this.stopDrawing());
        
        // Touch events
        this.canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            this.startDrawing(touch);
        });
        this.canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            this.draw(touch);
        });
        this.canvas.addEventListener('touchend', (e) => {
            e.preventDefault();
            this.stopDrawing();
        });
        this.canvas.addEventListener('touchcancel', (e) => {
            e.preventDefault();
            this.stopDrawing();
        });

        // Resize handling
        window.addEventListener('resize', () => this.resizeCanvas());
    }
    
    resizeCanvas() {
        const container = document.getElementById('canvas-container');
        const maxWidth = Math.min(this.canvas.width, container.clientWidth - 20);
        const scale = maxWidth / this.canvas.width;
        
        if (scale < 1) {
            this.canvas.style.width = maxWidth + 'px';
            this.canvas.style.height = (this.canvas.height * scale) + 'px';
        } else {
            this.canvas.style.width = this.canvas.width + 'px';
            this.canvas.style.height = this.canvas.height + 'px';
        }
    }
    
    getMousePos(e) {
        const rect = this.canvas.getBoundingClientRect();
        const scaleX = this.canvas.width / rect.width;
        const scaleY = this.canvas.height / rect.height;
        
        const clientX = e.clientX !== undefined ? e.clientX : e.pageX;
        const clientY = e.clientY !== undefined ? e.clientY : e.pageY;
        
        return {
            x: (clientX - rect.left) * scaleX,
            y: (clientY - rect.top) * scaleY
        };
    }
    
    startDrawing(e) {
        this.isDrawing = true;
        const pos = this.getMousePos(e);
        this.currentLine = [pos];
        this.ctx.beginPath();
        this.ctx.strokeStyle = '#000';
        this.ctx.lineWidth = 2;
        this.ctx.moveTo(pos.x, pos.y);
    }
    
    draw(e) {
        if (!this.isDrawing) return;
        const pos = this.getMousePos(e);
        this.currentLine.push(pos);
        this.ctx.lineTo(pos.x, pos.y);
        this.ctx.stroke();
    }
    
    stopDrawing() {
        if (!this.isDrawing) return;
        this.isDrawing = false;
        if (this.currentLine && this.currentLine.length > 1) {
            this.masterLines.push(this.currentLine);
            this.updateStatus();
        }
    }
    
    updateStatus() {
        const status = document.getElementById('status');
        if (this.masterLines.length === 0) {
            status.textContent = 'Draw at least two master lines by clicking and dragging on the canvas.';
        } else if (this.masterLines.length === 1) {
            status.textContent = 'Draw one more master line to generate a pattern.';
        } else {
            status.textContent = `${this.masterLines.length} master lines drawn. Click "Generate" to create interpolations.`;
        }
    }
    
    generatePattern() {
        if (this.masterLines.length < 2) {
            alert('Please draw at least two master lines first');
            return;
        }
        const steps = parseInt(document.getElementById('interpolations').value, 10);
        const masterLinesCopy = [...this.masterLines];
        this.clear(false);

        this.ctx.strokeStyle = '#000';
        this.ctx.lineWidth = 2;
        masterLinesCopy.forEach(line => {
            this.ctx.beginPath();
            this.ctx.moveTo(line[0].x, line[0].y);
            line.forEach(point => this.ctx.lineTo(point.x, point.y));
            this.ctx.stroke();
        });

        this.ctx.strokeStyle = '#666';
        this.ctx.lineWidth = 1;
        for (let i = 0; i < masterLinesCopy.length - 1; i++) {
            const line1 = masterLinesCopy[i];
            const line2 = masterLinesCopy[i + 1];
            const pointCount = Math.min(line1.length, line2.length);
            for (let step = 1; step < steps; step++) {
                const t = step / steps;
                this.ctx.beginPath();
                const x0 = line1[0].x + (line2[0].x - line1[0].x) * t;
                const y0 = line1[0].y + (line2[0].y - line1[0].y) * t;
                this.ctx.moveTo(x0, y0);
                for (let j = 1; j < pointCount; j++) {
                    const x = line1[j].x + (line2[j].x - line1[j].x) * t;
                    const y = line1[j].y + (line2[j].y - line1[j].y) * t;
                    this.ctx.lineTo(x, y);
                }
                this.ctx.stroke();
            }
        }
        this.masterLines = masterLinesCopy;
    }
    
    clear(resetMasterLines = true) {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        if (resetMasterLines) {
            this.masterLines = [];
            this.updateStatus();
        }
    }
    
    undoLastLine() {
        if (this.masterLines.length > 0) {
            this.masterLines.pop();
            this.clear(false);
            this.ctx.strokeStyle = '#000';
            this.ctx.lineWidth = 2;
            this.masterLines.forEach(line => {
                this.ctx.beginPath();
                this.ctx.moveTo(line[0].x, line[0].y);
                line.forEach(point => this.ctx.lineTo(point.x, point.y));
                this.ctx.stroke();
            });
            this.updateStatus();
        }
    }
    
    setResolution(value) {
        this.resolution = value;
    }
    
    downloadPNG() {
        const link = document.createElement('a');
        link.download = 'trpl-pattern.png';
        link.href = this.canvas.toDataURL('image/png');
        link.click();
    }
}

const canvas = document.getElementById('drawingCanvas');
const trpl = new TRPL(canvas);

document.getElementById('generateBtn').addEventListener('click', () => trpl.generatePattern());
document.getElementById('clearBtn').addEventListener('click', () => trpl.clear());
document.getElementById('undoBtn').addEventListener('click', () => trpl.undoLastLine());
document.getElementById('resolution').addEventListener('change', (e) => trpl.setResolution(parseInt(e.target.value, 10)));
document.getElementById('width').addEventListener('change', (e) => { 
    canvas.width = parseInt(e.target.value, 10); 
    trpl.clear(); 
    trpl.resizeCanvas();
});
document.getElementById('height').addEventListener('change', (e) => { 
    canvas.height = parseInt(e.target.value, 10); 
    trpl.clear(); 
    trpl.resizeCanvas();
});
document.getElementById('downloadBtn').addEventListener('click', () => trpl.downloadPNG());
document.getElementById('museumBtn').addEventListener('click', openMuseumText);

function openMuseumText() {
    const url = 'trpl_text.html';
    const w = Math.min(900, window.screen.width - 100);
    const h = Math.min(700, window.screen.height - 100);
    const left = Math.max(0, Math.round((window.screen.width - w) / 2));
    const top = Math.max(0, Math.round((window.screen.height - h) / 2));
    const features = `popup=yes,scrollbars=yes,resizable=yes,width=${w},height=${h},left=${left},top=${top}`;
    const win = window.open(url, 'TRPLTextPanel', features);
    if (!win) window.open(url, '_blank'); else win.focus();
}
</script>
</body>
</html>
