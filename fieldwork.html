<!DOCTYPE html>
<html>
<head>
    <title>Field Work 3: A Structured Arena</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #111;
            font-family: Arial, sans-serif;
        }

        #canvas {
            width: 100vw;
            height: 100vh;
        }

        .controls {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 8px;
            color: white; /* fixed */
            z-index: 10;
        }

        .controls label {
            display: block;
            margin: 10px 0;
        }

        .controls input {
            margin-left: 10px;
            width: 120px;
        }

        .controls .action-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .controls button {
            margin-top: 10px;
            padding: 8px 12px;
            background: #007bff;
            border: none;
            border-radius: 4px;
            color: white; /* fixed */
            cursor: pointer;
        }

        .controls button:hover {
            background: #0056b3;
        }

        .info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            color: white; /* fixed */
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 8px;
            max-width: 300px;
            z-index: 10;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>

    <div class="controls">
        <label>
            Wave Height:
            <input type="range" id="heightRange" min="0" max="100" value="30">
        </label>
        <label>
            Wave Speed:
            <input type="range" id="speedRange" min="0" max="100" value="50">
        </label>
        <label>
            Light Intensity:
            <input type="range" id="lightRange" min="0" max="100" value="70">
        </label>
        <div class="action-row">
            <button onclick="downloadImage()">Download as PNG</button>
            <button onclick="openMuseumText()" aria-label="Open museum text panel">Open museum text</button>
        </div>
    </div>

    <div class="info">
        <h3>Field Work 3: A Structured Arena</h3>
        <p>An interactive visualisation of Timothy Drever’s conceptual work featuring a wave-structured surface.</p>
        <p>• Move mouse to change perspective</p>
        <p>• Use sliders to adjust wave height, speed, and lighting</p>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        let waveHeight = 30;
        let waveSpeed = 0.5;
        let lightIntensity = 0.7;
        let time = 0;

        const gridSize = 30;
        const cellSize = 20;

        let mouseX = 0;
        let mouseY = 0;
        canvas.addEventListener('mousemove', (e) => {
            mouseX = (e.clientX / window.innerWidth - 0.5) * 2;
            mouseY = (e.clientY / window.innerHeight - 0.5) * 2;
        });

        document.getElementById('heightRange').addEventListener('input', (e) => {
            waveHeight = e.target.value / 2;
        });

        document.getElementById('speedRange').addEventListener('input', (e) => {
            waveSpeed = e.target.value / 100;
        });

        document.getElementById('lightRange').addEventListener('input', (e) => {
            lightIntensity = e.target.value / 100;
        });

        function calculateWaveHeight(x, y, time) {
            const dx = x - gridSize / 2;
            const dy = y - gridSize / 2;
            const distance = Math.sqrt(dx * dx + dy * dy);

            return Math.sin(distance * 0.3 + time) * waveHeight +
                   Math.sin((x * 0.5 + y * 0.5 + time) * 0.5) * waveHeight;
        }

        function calculateColor(height, maxHeight) {
            const normalised = (height + maxHeight) / (2 * maxHeight);
            const base = Math.floor(normalised * 255);
            const light = lightIntensity * (0.7 + 0.3 * normalised);
            return `rgb(${base * light}, ${base * light}, ${Math.floor(base * light * 1.2)})`;
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const offsetX = canvas.width / 2 - (gridSize * cellSize) / 2;
            const offsetY = canvas.height / 2 - (gridSize * cellSize) / 2;

            const perspectiveX = mouseX * 100;
            const perspectiveY = mouseY * 100;

            for (let y = 0; y < gridSize; y++) {
                for (let x = 0; x < gridSize; x++) {
                    const height = calculateWaveHeight(x, y, time);

                    const px1 = offsetX + x * cellSize + perspectiveX * (y / gridSize);
                    const py1 = offsetY + y * cellSize + perspectiveY * (y / gridSize) + height;
                    const px2 = px1 + cellSize;
                    const py2 = py1;

                    ctx.beginPath();
                    ctx.moveTo(px1, py1);
                    ctx.lineTo(px2, py2);
                    ctx.strokeStyle = calculateColor(height, waveHeight);
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            }

            time += waveSpeed * 0.05;
            requestAnimationFrame(draw);
        }

        function downloadImage() {
            const link = document.createElement('a');
            link.download = 'field-work-3.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        // popup opener
        function openMuseumText() {
            const url = 'fieldworktext.html'; // place this file beside the current page
            const w = Math.min(900, window.screen.width - 100);
            const h = Math.min(700, window.screen.height - 100);
            const left = Math.max(0, Math.round((window.screen.width - w) / 2));
            const top = Math.max(0, Math.round((window.screen.height - h) / 2));
            const features = `popup=yes,scrollbars=yes,resizable=yes,width=${w},height=${h},left=${left},top=${top}`;
            const win = window.open(url, 'FieldWork3TextPanel', features);
            if (!win) window.open(url, '_blank');
            else win.focus();
        }

        draw();
    </script>
</body>
</html>

